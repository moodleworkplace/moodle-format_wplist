define ("format_wplist/main",["jquery","core/sortable_list","core/notification","core/custom_interaction_events","core/ajax","core/str","core/templates"],function(a,b,c,d,e,f,g){var h={SECTION_CONTAINER:"[data-region=\"section-container\"]",SECTION:"[data-region=\"section\"]",MODULES_CONTAINER:"[data-region=\"course-modules\"]",MODULE:"[data-region=\"module\"]",COMPLETIONCHECKS:"[data-region=\"completioncheck\"]",EXPAND_TOGGLE:"[data-toggle=\"collapse\"]",EXPAND_SECTIONS:"[data-action=\"expand\"]",EXPAND_SECTIONS_OPEN:"[data-region=\"collapsed-open\"]",EXPAND_SECTIONS_CLOSED:"[data-region=\"collapsed-closed\"]",EXPAND_SECTIONS_CONTENT:"[data-region=\"sectioncollapse\"]",COMPLETION_CONTAINER:"[data-actions=\"availability\"]",COMPLETION_INFO:"[data-region=\"availabilityinfo\"]"},i=function(a){var b=e.call([{methodname:"format_wplist_move_section",args:a}])[0];b.fail(c.exception);return b},j=function(a){var b=e.call([{methodname:"format_wplist_move_module",args:a}])[0];b.fail(c.exception);return b},k=function(a){var b=e.call([{methodname:"format_wplist_module_completion",args:a}])[0];b.fail(c.exception);return b},l=function(a,b,c){var d=a.find("#sectionprogress-"+b),e=d.attr("data-completed-modules"),g=d.attr("data-completion-modules");if(1===c){e++}else{e--}var h=100*(e/g);f.get_string("section_completion","format_wplist",h).done(function(a){d.attr("title",a);d.attr("data-completed-modules",e);d.css("width",h+"%")})},m=function(a,b,c){if(c){if(0===a.find(".sectioncontent.collapse.show").length){b=1}else if(0===a.find(".sectioncontent.collapse:not(.show)").length){b=0}else{return!1}}var d=a.find(h.EXPAND_SECTIONS),e=d.find(h.EXPAND_SECTIONS_OPEN),f=d.find(h.EXPAND_SECTIONS_CLOSED);if(0===b){e.removeClass("hidden");f.addClass("hidden");d.attr("data-expanded",1)}else{e.addClass("hidden");f.removeClass("hidden");d.attr("data-expanded",0)}return!0},n=function(e,n){d.define(e,[d.events.activate]);e.on(d.events.activate,h.EXPAND_SECTIONS,function(b){var c=parseInt(a(b.target).closest(h.EXPAND_SECTIONS).attr("data-expanded"));if(0===c){a(h.EXPAND_SECTIONS_CONTENT).each(function(){a(this).addClass("show")});a(h.EXPAND_TOGGLE).each(function(){a(this).removeClass("collapsed")});m(e,0,!1);o(e,0,!0,!0,n)}else{a(h.EXPAND_SECTIONS_CONTENT).each(function(){a(this).removeClass("show")});a(h.EXPAND_TOGGLE).each(function(){a(this).addClass("collapsed")});m(e,1,!1);o(e,0,!0,!1,n)}});a(h.EXPAND_SECTIONS_CONTENT).on("hidden.bs.collapse",function(){var b=a(this).data("sectionid"),c=a(this).data("sectionnumber"),d=a(this).data("isaccordion"),g=a(this).data("sectionname");m(e,1,!0);f.get_string("expandsection","format_wplist",g).done(function(f){a(".course-section-toggle[data-target=\"#sectioncontent-"+c+"\"]").attr("title",f);o(e,b,d,!1,n)})});a(h.EXPAND_SECTIONS_CONTENT).on("shown.bs.collapse",function(){var b=a(this).data("sectionid"),c=a(this).data("sectionnumber"),d=a(this).data("isaccordion"),g=a(this).data("sectionname");m(e,0,!0);f.get_string("collapsesection","format_wplist",g).done(function(f){a(".course-section-toggle[data-target=\"#sectioncontent-"+c+"\"]").attr("title",f);o(e,b,d,!0,n)})});e.on(d.events.activate,h.COMPLETIONCHECKS,function(b){var d=a(b.target).closest(h.COMPLETIONCHECKS),f=parseInt(d.attr("data-module")),i=parseInt(d.attr("data-targetstate")),j=parseInt(d.attr("data-courseid")),m=parseInt(d.attr("data-sectionnumber"));k({moduleid:f,targetstate:i,courseid:j}).then(function(a){l(e,m,i);g.replaceNode(d,a.completionicon,"");return null}).fail(c.exception)});var p=e.find(h.SECTION_CONTAINER),q=e.find(h.SECTION),r=p.attr("data-courseid"),s=function(a){return a.find("h3.sectionname .inplaceeditable").text()},t=function(a){return a.find(".cmname .inplaceeditable").text()},u=function(a){return a.closest("[data-region=\"section\"][data-sectionnumber]")},v=new b(p,{moveHandlerSelector:".movesection > [data-drag-type=move]"});v.getElementName=function(b){return a.Deferred().resolve(s(b))};var w=e.find(h.MODULES_CONTAINER),x=new b(w,{moveHandlerSelector:".movemodule > [data-drag-type=move]"});x.getElementName=function(b){return a.Deferred().resolve(t(b))};x.getDestinationName=function(b,c){if(!c.length){return f.get_string("totopofsection","moodle",s(u(b)))}else{if(0===a(c).find(".cmname").length){return null}else{return f.get_string("movecontentafter","moodle",t(c))}}};q.on(b.EVENTS.DROP,function(a,b){a.stopPropagation();var d,e;if(b.positionChanged){if(b.element.attr("data-sectionnumber")){if(b.targetNextElement&&"0"===b.targetNextElement.attr("data-sectionnumber")){v.moveElement(b.sourceList,b.sourceNextElement);return}d=b.element.attr("data-sectionnumber");var f=b.targetNextElement.attr("data-sectionnumber");e={sectionnumber:d,sectiontarget:f,courseid:r};i(e).then(function(){b.element.attr("data-sectionnumber",f);b.targetNextElement.attr("data-sectionnumber",d);return null}).catch(c.exception)}if(b.element.attr("data-module")){var g=b.element.attr("data-module"),h=b.targetNextElement.attr("data-module");d=u(b.targetList).attr("data-sectionnumber");e={moduleid:g,moduletarget:h,sectionnumber:d,courseid:r};if("undefined"!=typeof g&&0!==g){j(e).catch(c.exception)}}}});var y=function(){e.find(h.SECTION).each(function(){var b=a(this).find(h.MODULES_CONTAINER),c=b.children().length-1;b.attr("data-nummodules",c);if(0===c){b.addClass("nomodules")}else{b.removeClass("nomodules")}})};y();q.on(b.EVENTS.DRAG,function(b,c){if(c.element.attr("data-module")){e.find(h.SECTION).each(function(){a(this).removeClass("movemodule")});var d=u(c.sourceList).find(h.MODULES_CONTAINER),f=parseInt(d.attr("data-nummodules"));if(1===f){d.addClass("nomodules")}var g=u(c.targetList);g.addClass("movemodule")}});q.on(b.EVENTS.DRAGEND,function(a,b){if(b.element.attr("data-module")){y()}})},o=function(b,d,f,g,h){var i=[];e.call([{methodname:"core_user_get_user_preferences",args:{name:"format_wplist_opensections_"+h}}])[0].then(function(c){if(0===d&&g){i=[];b.find(".sectioncontent.collapse").each(function(){var b=a(this).data("sectionid");i.push(b)})}else if(f){if(g){i=[d]}else{i=[]}}else{if(c.preferences.length&&c.preferences[0].value){i=JSON.parse(c.preferences[0].value)}var j=i.indexOf(d);if(g){if(-1===j){i.push(d)}}else{if(-1<j){i.splice(j,1)}}}var k={methodname:"core_user_update_user_preferences",args:{preferences:[{type:"format_wplist_opensections_"+h,value:JSON.stringify(i)}]}};return e.call([k])[0]}).fail(c.exception)};return{init:function init(b,c){b=a(b);n(b,c)}}});
//# sourceMappingURL=main.min.js.map
