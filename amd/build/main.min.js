define(["jquery","core/sortable_list","core/notification","core/custom_interaction_events","core/ajax","core/str"],function(a,b,c,d,e,f){var g={SECTION_CONTAINER:'[data-region="section-container"]',SECTION:'[data-region="section"]',MODULES_CONTAINER:'[data-region="course-modules"]',MODULE:'[data-region="module"]',COMPLETIONCHECKS:'[data-region="completioncheck"]',COMPLETION_ON:'[data-region="checkon"]',COMPLETION_OFF:'[data-region="checkoff"]',EXPAND_TOGGLE:'[data-toggle="collapse"]',EXPAND_SECTIONS:'[data-action="expand"]',EXPAND_SECTIONS_OPEN:'[data-region="collapsed-open"]',EXPAND_SECTIONS_CLOSED:'[data-region="collapsed-closed"]',EXPAND_SECTIONS_CONTENT:'[data-region="sectioncollapse"]',COMPLETION_CONTAINER:'[data-actions="availability"]',COMPLETION_INFO:'[data-region="availabilityinfo"]'},h=function(a){var b={methodname:"format_wplist_move_section",args:a},d=e.call([b])[0];return d.fail(c.exception),d},i=function(a){var b={methodname:"format_wplist_move_module",args:a},d=e.call([b])[0];return d.fail(c.exception),d},j=function(a){var b={methodname:"format_wplist_module_completion",args:a},d=e.call([b])[0];return d.fail(c.exception),d},k=function(a,b){b?(a.attr("data-checked",0),a.attr("data-targetstate",1),a.find(g.COMPLETION_ON).addClass("hidden"),a.find(g.COMPLETION_OFF).removeClass("hidden")):(a.attr("data-checked",1),a.attr("data-targetstate",0),a.find(g.COMPLETION_ON).removeClass("hidden"),a.find(g.COMPLETION_OFF).addClass("hidden"))},l=function(a,b,c){var d=a.find("#sectionprogress-"+b),e=d.attr("data-completed-modules"),f=d.attr("data-completion-modules");1===c?e++:e--,d.attr("data-completed-modules",e);var g=100*(e/f);d.css("width",g+"%")},m=function(e){d.define(e,[d.events.activate]),e.on(d.events.activate,g.EXPAND_SECTIONS,function(b){var c=a(b.target).closest(g.EXPAND_SECTIONS),d=c.find(g.EXPAND_SECTIONS_OPEN),e=c.find(g.EXPAND_SECTIONS_CLOSED),f=parseInt(c.attr("data-expanded"));0===f?(a(g.EXPAND_SECTIONS_CONTENT).each(function(){a(this).addClass("show")}),a(g.EXPAND_TOGGLE).each(function(){a(this).removeClass("collapsed")}),d.removeClass("hidden"),e.addClass("hidden"),c.attr("data-expanded",1)):(a(g.EXPAND_SECTIONS_CONTENT).each(function(){a(this).removeClass("show")}),a(g.EXPAND_TOGGLE).each(function(){a(this).addClass("collapsed")}),d.addClass("hidden"),e.removeClass("hidden"),c.attr("data-expanded",0))}),a(g.EXPAND_SECTIONS_CONTENT).on("hidden.bs.collapse",function(){var b=a(this).attr("data-sectionid"),c=a(this).attr("data-isaccordion");n(b,c,!1)}),a(g.EXPAND_SECTIONS_CONTENT).on("shown.bs.collapse",function(){var b=a(this).attr("data-sectionid"),c=a(this).attr("data-isaccordion");n(b,c,!0)}),e.on(d.events.activate,g.COMPLETIONCHECKS,function(b){var d=a(b.target).closest(g.COMPLETIONCHECKS),f=parseInt(d.attr("data-module")),h=parseInt(d.attr("data-targetstate")),i=parseInt(d.attr("data-courseid")),m=parseInt(d.attr("data-checked")),n=parseInt(d.attr("data-sectionnumber")),o={moduleid:f,targetstate:h,courseid:i};j(o).then(function(){return k(d,m),l(e,n,h),null}).fail(c.exception)});var m=e.find(g.SECTION_CONTAINER),o=e.find(g.SECTION),p=m.attr("data-courseid"),q=function(a){return a.find("h3.sectionname .inplaceeditable").text()},r=function(a){return a.find(".cmname .inplaceeditable").text()},s=function(a){return a.closest('[data-region="section"][data-sectionnumber]')},t=new b(m,{moveHandlerSelector:".movesection > [data-drag-type=move]"});t.getElementName=function(b){return a.Deferred().resolve(q(b))};var u=e.find(g.MODULES_CONTAINER),v=new b(u,{moveHandlerSelector:".movemodule > [data-drag-type=move]"});v.getElementName=function(b){return a.Deferred().resolve(r(b))},v.getDestinationName=function(b,c){return c.length?0===a(c).find(".cmname").length?null:f.get_string("movecontentafter","moodle",r(c)):f.get_string("totopofsection","moodle",q(s(b)))},o.on(b.EVENTS.DROP,function(a,b){a.stopPropagation();var d,e;if(b.positionChanged){if(b.element.attr("data-sectionnumber")){if(b.targetNextElement&&"0"===b.targetNextElement.attr("data-sectionnumber"))return void t.moveElement(b.sourceList,b.sourceNextElement);d=b.element.attr("data-sectionnumber");var f=b.targetNextElement.attr("data-sectionnumber");e={sectionnumber:d,sectiontarget:f,courseid:p},h(e).then(function(){return b.element.attr("data-sectionnumber",f),b.targetNextElement.attr("data-sectionnumber",d),null})["catch"](c.exception)}if(b.element.attr("data-module")){var g=b.element.attr("data-module"),j=b.targetNextElement.attr("data-module");d=s(b.targetList).attr("data-sectionnumber"),e={moduleid:g,moduletarget:j,sectionnumber:d,courseid:p},"undefined"!=typeof g&&0!==g&&i(e)["catch"](c.exception)}}});var w=function(){e.find(g.SECTION).each(function(){var b=a(this).find(g.MODULES_CONTAINER),c=b.children().length-1;b.attr("data-nummodules",c),0===c?b.addClass("nomodules"):b.removeClass("nomodules")})};w(),o.on(b.EVENTS.DRAG,function(b,c){if(c.element.attr("data-module")){e.find(g.SECTION).each(function(){a(this).removeClass("movemodule")});var d=s(c.sourceList).find(g.MODULES_CONTAINER),f=parseInt(d.attr("data-nummodules"));1===f&&d.addClass("nomodules");var h=s(c.targetList);h.addClass("movemodule")}}),o.on(b.EVENTS.DRAGEND,function(a,b){b.element.attr("data-module")&&w()})},n=function(a,b,d){var f={methodname:"core_user_get_user_preferences",args:{name:"format_wplist_opensections"}},g=[];e.call([f])[0].then(function(c){if(b)g=d?[a]:[];else{c.preferences.length&&c.preferences[0].value&&(g=JSON.parse(c.preferences[0].value));var f=g.indexOf(a);d?f===-1&&g.push(a):f>-1&&g.splice(f,1)}var h={methodname:"core_user_update_user_preferences",args:{preferences:[{type:"format_wplist_opensections",value:JSON.stringify(g)}]}};return e.call([h])[0]}).fail(c.exception)},o=function(b){b=a(b),m(b)};return{init:o}});