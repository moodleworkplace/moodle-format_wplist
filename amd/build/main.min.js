/**
 * Javascript for course format workplace list.
 *
 * @module     format_wplist/main
 * @copyright  2019 Moodle Pty Ltd <support@moodle.com>
 * @author     2019 <bas@moodle.com>
 * @license    Moodle Workplace License, distribution is restricted, contact support@moodle.com
 */
define("format_wplist/main",["jquery","core/sortable_list","core/notification","core/custom_interaction_events","core/ajax","core/str","core/templates","theme_boost/popover"],(function($,Sortablewplist,Notification,CustomEvents,Ajax,Str,Templates,Popover){var SELECTORS_SECTION_CONTAINER='[data-region="section-container"]',SELECTORS_SECTION='[data-region="section"]',SELECTORS_MODULES_CONTAINER='[data-region="course-modules"]',SELECTORS_COMPLETIONCHECKS='[data-region="completioncheck"]',SELECTORS_EXPAND_TOGGLE='[data-toggle="collapse"]',SELECTORS_EXPAND_SECTIONS='[data-action="expand"]',SELECTORS_EXPAND_SECTIONS_OPEN='[data-region="collapsed-open"]',SELECTORS_EXPAND_SECTIONS_CLOSED='[data-region="collapsed-closed"]',SELECTORS_EXPAND_SECTIONS_CONTENT='[data-region="sectioncollapse"]',updateSectionCollapse=function(root,open,auto){if(auto)if(0===root.find(".sectioncontent.collapse.show").length)open=1;else{if(0!==root.find(".sectioncontent.collapse:not(.show)").length)return!1;open=0}var expand=root.find(SELECTORS_EXPAND_SECTIONS),openmsg=expand.find(SELECTORS_EXPAND_SECTIONS_OPEN),closedmsg=expand.find(SELECTORS_EXPAND_SECTIONS_CLOSED);return 0===open?(openmsg.removeClass("hidden"),closedmsg.addClass("hidden"),expand.attr("data-expanded",1)):(openmsg.addClass("hidden"),closedmsg.removeClass("hidden"),expand.attr("data-expanded",0)),!0},registerEventListeners=function(root,contextid){CustomEvents.define(root,[CustomEvents.events.activate]),root.on(CustomEvents.events.activate,SELECTORS_EXPAND_SECTIONS,(function(e){0===parseInt($(e.target).closest(SELECTORS_EXPAND_SECTIONS).attr("data-expanded"))?($(SELECTORS_EXPAND_SECTIONS_CONTENT).each((function(){$(this).addClass("show")})),$(SELECTORS_EXPAND_TOGGLE).each((function(){$(this).removeClass("collapsed")})),updateSectionCollapse(root,0,!1),storeSectionPreference(root,0,!0,!0,contextid)):($(SELECTORS_EXPAND_SECTIONS_CONTENT).each((function(){$(this).removeClass("show")})),$(SELECTORS_EXPAND_TOGGLE).each((function(){$(this).addClass("collapsed")})),updateSectionCollapse(root,1,!1),storeSectionPreference(root,0,!0,!1,contextid))})),$(SELECTORS_EXPAND_SECTIONS_CONTENT).on("hidden.bs.collapse",(function(){var sectionid=$(this).data("sectionid"),sectionnumber=$(this).data("sectionnumber"),isaccordion=$(this).data("isaccordion"),sectionname=$(this).data("sectionname");updateSectionCollapse(root,1,!0),Str.get_string("expandsection","format_wplist",sectionname).done((function(s){$('.course-section-toggle[data-target="#sectioncontent-'+sectionnumber+'"]').attr("title",s),storeSectionPreference(root,sectionid,isaccordion,!1,contextid)}))})),$(SELECTORS_EXPAND_SECTIONS_CONTENT).on("shown.bs.collapse",(function(){var sectionid=$(this).data("sectionid"),sectionnumber=$(this).data("sectionnumber"),isaccordion=$(this).data("isaccordion"),sectionname=$(this).data("sectionname");updateSectionCollapse(root,0,!0),Str.get_string("collapsesection","format_wplist",sectionname).done((function(s){$('.course-section-toggle[data-target="#sectioncontent-'+sectionnumber+'"]').attr("title",s),storeSectionPreference(root,sectionid,isaccordion,!0,contextid)}))})),root.on(CustomEvents.events.activate,SELECTORS_COMPLETIONCHECKS,(function(e){var cc=$(e.target).closest(SELECTORS_COMPLETIONCHECKS),moduleid=parseInt(cc.attr("data-module")),targetstate=parseInt(cc.attr("data-targetstate")),courseid=parseInt(cc.attr("data-courseid")),sectionnumber=parseInt(cc.attr("data-sectionnumber")),reloadOnChange=parseInt(cc.attr("data-reloadonchange"));(function(args){var request={methodname:"format_wplist_module_completion",args:args},promise=Ajax.call([request])[0];return promise.fail(Notification.exception),promise})({moduleid:moduleid,targetstate:targetstate,courseid:courseid}).then((function(html){return reloadOnChange&&window.location.reload(),function(root,sectionnumber,targetstate){var sectionprogress=root.find("#sectionprogress-"+sectionnumber),completedmodules=sectionprogress.attr("data-completed-modules"),completionmodules=sectionprogress.attr("data-completion-modules");1===targetstate?completedmodules++:completedmodules--;var newCompletionPercentage=completedmodules/completionmodules*100;Str.get_string("section_completion","format_wplist",newCompletionPercentage).done((function(s){sectionprogress.attr("title",s),sectionprogress.attr("data-completed-modules",completedmodules),sectionprogress.css("width",newCompletionPercentage+"%")}))}(root,sectionnumber,targetstate),Templates.replaceNode(cc,html.completionicon,""),null})).fail(Notification.exception)}));var sectionsContainer=root.find(SELECTORS_SECTION_CONTAINER),sections=root.find(SELECTORS_SECTION),courseid=sectionsContainer.attr("data-courseid"),getSectionName=function(element){return element.find("h3.sectionname .inplaceeditable").text()},getModuleName=function(element){return element.find(".cmname .inplaceeditable").text()},findClosestSection=function(element){return element.closest('[data-region="section"][data-sectionnumber]')},sectionsSortable=new Sortablewplist(sectionsContainer,{moveHandlerSelector:".movesection > [data-drag-type=move]"});sectionsSortable.getElementName=function(element){return $.Deferred().resolve(getSectionName(element))};var modulesContainers=root.find(SELECTORS_MODULES_CONTAINER),modulesSortable=new Sortablewplist(modulesContainers,{moveHandlerSelector:".movemodule > [data-drag-type=move]"});modulesSortable.getElementName=function(element){return $.Deferred().resolve(getModuleName(element))},modulesSortable.getDestinationName=function(parentElement,afterElement){return afterElement.length?0===$(afterElement).find(".cmname").length?null:Str.get_string("movecontentafter","moodle",getModuleName(afterElement)):Str.get_string("totopofsection","moodle",getSectionName(findClosestSection(parentElement)))},sections.on(Sortablewplist.EVENTS.DROP,(function(e,info){var sectionnumber,args;if(e.stopPropagation(),info.positionChanged){if(info.element.attr("data-sectionnumber")){if(info.targetNextElement&&"0"===info.targetNextElement.attr("data-sectionnumber"))return void sectionsSortable.moveElement(info.sourceList,info.sourceNextElement);sectionnumber=info.element.attr("data-sectionnumber");var sectiontarget=info.targetNextElement.attr("data-sectionnumber");(function(args){var request={methodname:"format_wplist_move_section",args:args},promise=Ajax.call([request])[0];return promise.fail(Notification.exception),promise})(args={sectionnumber:sectionnumber,sectiontarget:sectiontarget,courseid:courseid}).then((function(){return info.element.attr("data-sectionnumber",sectiontarget),info.targetNextElement.attr("data-sectionnumber",sectionnumber),null})).catch(Notification.exception)}if(info.element.attr("data-module")){var moduleid=info.element.attr("data-module");args={moduleid:moduleid,moduletarget:info.targetNextElement.attr("data-module"),sectionnumber:sectionnumber=findClosestSection(info.targetList).attr("data-sectionnumber"),courseid:courseid},void 0!==moduleid&&0!==moduleid&&function(args){var request={methodname:"format_wplist_move_module",args:args},promise=Ajax.call([request])[0];return promise.fail(Notification.exception),promise}(args).catch(Notification.exception)}}}));var countmodules=function(){root.find(SELECTORS_SECTION).each((function(){var modulesContainer=$(this).find(SELECTORS_MODULES_CONTAINER),nummodules=modulesContainer.children().length-1;modulesContainer.attr("data-nummodules",nummodules),0===nummodules?modulesContainer.addClass("nomodules"):modulesContainer.removeClass("nomodules")}))};countmodules(),sections.on(Sortablewplist.EVENTS.DRAG,(function(e,info){if(info.element.attr("data-module")){sections.each((function(){$(this).removeClass("movemodule")}));var oldSectionModules=findClosestSection(info.sourceList).find(SELECTORS_MODULES_CONTAINER);1===parseInt(oldSectionModules.attr("data-nummodules"))&&oldSectionModules.addClass("nomodules"),findClosestSection(info.targetList).addClass("movemodule")}})),sections.on(Sortablewplist.EVENTS.DRAGEND,(function(e,info){info.element.attr("data-module")&&(countmodules(),findClosestSection(info.element).removeClass("movemodule"))}))},storeSectionPreference=function(root,sectionid,isaccordion,opened,contextid){var requestget={methodname:"core_user_get_user_preferences",args:{name:"format_wplist_opensections_"+contextid}},sections=[];Ajax.call([requestget])[0].then((function(p){if(0===sectionid&&opened)sections=[],root.find(".sectioncontent.collapse").each((function(){var sectionid=$(this).data("sectionid");sections.push(sectionid)}));else if(isaccordion)sections=opened?[sectionid]:[];else{p.preferences.length&&p.preferences[0].value&&(sections=JSON.parse(p.preferences[0].value));var index=sections.indexOf(sectionid);opened?-1===index&&sections.push(sectionid):index>-1&&sections.splice(index,1)}var requestset={methodname:"core_user_update_user_preferences",args:{preferences:[{type:"format_wplist_opensections_"+contextid,value:JSON.stringify(sections)}]}};return Ajax.call([requestset])[0]})).fail(Notification.exception)};return{init:function(root,contextid){root=$(root),registerEventListeners(root,contextid),$('[data-region="availability-popover"]').popover({sanitize:!1})}}}));

//# sourceMappingURL=main.min.js.map